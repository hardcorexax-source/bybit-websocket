<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Живой свечной график BTC/USDT с историей</title>

  <!-- Highcharts Stock -->
  <script src="https://code.highcharts.com/stock/highstock.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>

  <style>
    :root {
      --tg-theme-bg-color: #ffffff;
      --tg-theme-text-color: #000000;
      --tg-theme-hint-color: #999999;
      --tg-theme-link-color: #2481cc;
      --tg-theme-button-color: #2481cc;
      --tg-theme-button-text-color: #ffffff;
      --tg-theme-secondary-bg-color: #f4f4f5;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      position: fixed;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    #controls {
      padding: 12px;
      background: var(--tg-theme-bg-color);
      border-bottom: 1px solid var(--tg-theme-hint-color);
      overflow-x: auto;
      white-space: nowrap;
      flex-shrink: 0;
      -webkit-overflow-scrolling: touch;
    }

    #controls::-webkit-scrollbar {
      display: none;
    }

    #controls strong {
      display: block;
      margin-bottom: 8px;
      font-size: 13px;
      color: var(--tg-theme-hint-color);
      font-weight: 500;
    }

    .interval-btn {
      padding: 6px 12px;
      margin-right: 6px;
      border: 1px solid var(--tg-theme-hint-color);
      background: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      display: inline-block;
      -webkit-tap-highlight-color: transparent;
    }

    .interval-btn:active {
      transform: scale(0.95);
    }

    .interval-btn.active {
      background: var(--tg-theme-button-color);
      color: var(--tg-theme-button-text-color);
      border-color: var(--tg-theme-button-color);
      font-weight: 500;
    }

    #container {
      flex: 1;
      width: 100%;
      background: var(--tg-theme-bg-color);
      overflow: hidden;
    }

    #info {
      padding: 10px 15px;
      background: var(--tg-theme-secondary-bg-color);
      font-size: 12px;
      color: var(--tg-theme-hint-color);
      border-top: 1px solid var(--tg-theme-hint-color);
      flex-shrink: 0;
    }
  </style>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

<div id="controls">
  <strong>Интервал свечей:</strong>
  <button class="interval-btn" data-interval="1000">1 секунда</button>
  <button class="interval-btn" data-interval="5000">5 секунд</button>
  <button class="interval-btn" data-interval="15000">15 секунд</button>
  <button class="interval-btn" data-interval="30000">30 секунд</button>
  <button class="interval-btn active" data-interval="60000">1 минута</button>
  <button class="interval-btn" data-interval="300000">5 минут</button>
  <button class="interval-btn" data-interval="900000">15 минут</button>
</div>
<div id="container"></div>
<div id="info">Загрузка данных...</div>

<script>
  // ========== ИНИЦИАЛИЗАЦИЯ TELEGRAM WEBAPP ==========
  let tg = window.Telegram?.WebApp;
  if (tg) {
    tg.ready();
    tg.expand();
    
    // Настройка нативного интерфейса Telegram
    tg.setHeaderColor('secondary_bg_color');
    
    // Показываем кнопку "Назад" (маленькая кнопка слева вверху)
    tg.BackButton.show();
    tg.BackButton.onClick(() => {
      tg.close();
    });
    
    // Отключаем вертикальные свайпы для закрытия
    tg.disableVerticalSwipes();
    
    // Применяем цветовую схему Telegram
    if (tg.themeParams) {
      document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
      document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
      document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#999999');
      document.documentElement.style.setProperty('--tg-theme-link-color', tg.themeParams.link_color || '#2481cc');
      document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#2481cc');
      document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
      document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f4f4f5');
    }
    
    // Настраиваем главную кнопку (появится когда пользователь зумирует)
    tg.MainButton.setText('Сбросить зум');
    tg.MainButton.color = tg.themeParams.button_color || '#2481cc';
    tg.MainButton.textColor = tg.themeParams.button_text_color || '#ffffff';
  }

  // ========== ПОЛУЧЕНИЕ ЦВЕТОВ ТЕМЫ ==========
  const getThemeColors = () => {
    const computedStyle = getComputedStyle(document.documentElement);
    return {
      bg: computedStyle.getPropertyValue('--tg-theme-bg-color').trim() || '#ffffff',
      text: computedStyle.getPropertyValue('--tg-theme-text-color').trim() || '#000000',
      hint: computedStyle.getPropertyValue('--tg-theme-hint-color').trim() || '#999999',
      button: computedStyle.getPropertyValue('--tg-theme-button-color').trim() || '#2481cc',
      secondaryBg: computedStyle.getPropertyValue('--tg-theme-secondary-bg-color').trim() || '#f4f4f5'
    };
  };

  // ========== НАСТРОЙКИ ГРАФИКА ==========
  const VISIBLE_CANDLES = 50;
  let CANDLE_INTERVAL = 60000;
  
  let allCandles = [];
  let isUserZooming = false;
  let socket = null;
  let reconnectAttempts = 0;
  const maxReconnectAttempts = 10;
  let reconnectTimeout = null;

  const themeColors = getThemeColors();

  // ========== СОЗДАНИЕ ГРАФИКА ==========
  const chart = Highcharts.stockChart('container', {
    chart: {
      backgroundColor: themeColors.bg,
      style: {
        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'
      },
      events: {
        selection: function(event) {
          if (event.xAxis) {
            isUserZooming = true;
            updateMainButton();
            return true;
          }
        }
      }
    },
    rangeSelector: { 
      enabled: true,
      buttonTheme: {
        fill: themeColors.bg,
        stroke: themeColors.hint,
        style: {
          color: themeColors.text
        },
        states: {
          hover: {
            fill: themeColors.secondaryBg,
            style: {
              color: themeColors.text
            }
          },
          select: {
            fill: themeColors.button,
            stroke: themeColors.button,
            style: {
              color: '#ffffff'
            }
          }
        }
      },
      inputStyle: {
        color: themeColors.text,
        backgroundColor: themeColors.bg
      },
      labelStyle: {
        color: themeColors.hint
      },
      buttons: [{
        type: 'minute',
        count: 5,
        text: '5m'
      }, {
        type: 'minute',
        count: 15,
        text: '15m'
      }, {
        type: 'minute',
        count: 30,
        text: '30m'
      }, {
        type: 'hour',
        count: 1,
        text: '1h'
      }, {
        type: 'all',
        text: 'Все'
      }],
      selected: 0,
      inputEnabled: false
    },
    title: { 
      text: 'BTC/USDT',
      style: {
        color: themeColors.text,
        fontSize: '16px',
        fontWeight: '600'
      }
    },
    xAxis: {
      lineColor: themeColors.hint,
      tickColor: themeColors.hint,
      labels: {
        style: {
          color: themeColors.text
        }
      },
      events: {
        afterSetExtremes: function(e) {
          if (e.trigger === 'rangeSelectorButton' || e.trigger === 'navigator') {
            isUserZooming = true;
            updateMainButton();
          }
          updateInfo();
        }
      }
    },
    yAxis: {
      gridLineColor: themeColors.hint,
      labels: {
        style: {
          color: themeColors.text
        }
      },
      opposite: true
    },
    series: [{
      type: 'candlestick',
      name: 'BTC/USDT',
      data: [],
      color: '#ef4444',
      upColor: '#10b981',
      lineColor: '#ef4444',
      upLineColor: '#10b981',
      tooltip: { 
        valueDecimals: 2,
        backgroundColor: themeColors.secondaryBg,
        borderColor: themeColors.hint,
        style: {
          color: themeColors.text
        }
      }
    }],
    tooltip: {
      backgroundColor: themeColors.secondaryBg,
      borderColor: themeColors.hint,
      style: {
        color: themeColors.text
      }
    },
    credits: { enabled: false },
    navigator: { 
      enabled: true,
      maskFill: themeColors.hint + '33',
      outlineColor: themeColors.hint,
      handles: {
        backgroundColor: themeColors.button,
        borderColor: themeColors.hint
      },
      xAxis: {
        gridLineColor: themeColors.hint,
        labels: {
          style: {
            color: themeColors.hint
          }
        }
      }
    },
    scrollbar: { 
      enabled: true,
      barBackgroundColor: themeColors.hint,
      barBorderColor: themeColors.hint,
      buttonBackgroundColor: themeColors.secondaryBg,
      buttonBorderColor: themeColors.hint,
      buttonArrowColor: themeColors.text,
      rifleColor: themeColors.text,
      trackBackgroundColor: themeColors.secondaryBg,
      trackBorderColor: themeColors.hint
    }
  });

  const series = chart.series[0];

  // ========== ОБНОВЛЕНИЕ ГЛАВНОЙ КНОПКИ TELEGRAM ==========
  function updateMainButton() {
    if (tg && tg.MainButton) {
      if (isUserZooming) {
        tg.MainButton.show();
      } else {
        tg.MainButton.hide();
      }
    }
  }

  // Обработчик нажатия на главную кнопку
  if (tg && tg.MainButton) {
    tg.MainButton.onClick(() => {
      isUserZooming = false;
      setVisibleRange();
      updateInfo();
      updateMainButton();
      
      // Вибрация при нажатии
      if (tg.HapticFeedback) {
        tg.HapticFeedback.impactOccurred('light');
      }
    });
  }

  // ========== ОБНОВЛЕНИЕ ИНФОРМАЦИИ ==========
  function updateInfo() {
    const visibleData = series.data.filter(point => point.isInside);
    const intervalText = CANDLE_INTERVAL >= 60000 
      ? `${CANDLE_INTERVAL/60000} мин` 
      : `${CANDLE_INTERVAL/1000} сек`;
    
    document.getElementById('info').textContent = 
      `Интервал: ${intervalText} | Всего свечей: ${allCandles.length} | Видимых: ${visibleData.length} | ` +
      `Режим: ${isUserZooming ? 'Ручной зум' : 'Авто-прокрутка'}`;
  }

  // ========== УСТАНОВКА ВИДИМОГО ДИАПАЗОНА ==========
  function setVisibleRange() {
    if (!isUserZooming && allCandles.length > 0) {
      const lastCandle = allCandles[allCandles.length - 1];
      const firstVisible = allCandles[Math.max(0, allCandles.length - VISIBLE_CANDLES)];
      
      chart.xAxis[0].setExtremes(
        firstVisible[0],
        lastCandle[0] + CANDLE_INTERVAL,
        true,
        false
      );
    }
  }

  // ========== ЗАГРУЗКА ИСТОРИЧЕСКИХ ДАННЫХ ==========
  async function loadHistory() {
    try {
      let apiInterval = '1m';
      if (CANDLE_INTERVAL >= 60000) {
        const minutes = CANDLE_INTERVAL / 60000;
        if (minutes >= 60) apiInterval = `${minutes/60}h`;
        else apiInterval = `${minutes}m`;
      }
      
      const url = `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${apiInterval}&limit=100`;
      const response = await fetch(url);
      const data = await response.json();

      allCandles = data.map(c => [
        c[0],
        parseFloat(c[1]),
        parseFloat(c[2]),
        parseFloat(c[3]),
        parseFloat(c[4])
      ]);

      series.setData(allCandles, false);
      setVisibleRange();
      chart.redraw();
      updateInfo();
      
      document.getElementById('info').textContent = `Загружено ${allCandles.length} свечей. Подключение к live данным...`;
    } catch (error) {
      console.error('Ошибка загрузки истории:', error);
      document.getElementById('info').textContent = 'Ошибка загрузки данных';
      
      if (tg && tg.showAlert) {
        tg.showAlert('Ошибка загрузки данных. Проверьте подключение к интернету.');
      }
    }
  }

  // ========== WEBSOCKET ДЛЯ РЕАЛЬНОГО ВРЕМЕНИ ==========
  function initWebSocket() {
    if (socket) {
      socket.onclose = null;
      socket.close();
    }

    socket = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@trade');

    socket.onopen = () => {
      console.log('WebSocket подключен');
      reconnectAttempts = 0;
      updateInfo();
    };

    socket.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      const price = parseFloat(msg.p);
      const time = msg.T;

      const candleTime = Math.floor(time / CANDLE_INTERVAL) * CANDLE_INTERVAL;
      let candleIndex = allCandles.findIndex(c => c[0] === candleTime);

      if (candleIndex === -1) {
        const newCandle = [candleTime, price, price, price, price];
        allCandles.push(newCandle);
        series.addPoint(newCandle, false);
        setVisibleRange();
        chart.redraw();
        updateInfo();
      } else {
        const candle = allCandles[candleIndex];
        candle[2] = Math.max(candle[2], price);
        candle[3] = Math.min(candle[3], price);
        candle[4] = price;
        
        if (series.data[candleIndex]) {
          series.data[candleIndex].update(candle, true, false);
        }
      }
    };

    socket.onerror = (err) => {
      console.error("WebSocket ошибка:", err);
    };

    socket.onclose = (event) => {
      console.warn("WebSocket закрыт", event.code, event.reason);
      
      if (reconnectAttempts < maxReconnectAttempts) {
        reconnectAttempts++;
        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
        console.log(`Переподключение через ${delay/1000} сек (попытка ${reconnectAttempts})`);
        
        if (reconnectTimeout) clearTimeout(reconnectTimeout);
        reconnectTimeout = setTimeout(initWebSocket, delay);
      } else {
        console.error('Превышено максимальное количество попыток переподключения');
        document.getElementById('info').textContent = 'Не удалось подключиться. Обновите страницу.';
      }
    };
  }

  // ========== ОБРАБОТЧИКИ КНОПОК ИНТЕРВАЛОВ ==========
  document.querySelectorAll('.interval-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      // Вибрация при нажатии
      if (tg && tg.HapticFeedback) {
        tg.HapticFeedback.impactOccurred('light');
      }
      
      document.querySelectorAll('.interval-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      CANDLE_INTERVAL = parseInt(btn.dataset.interval);
      
      if (socket) {
        socket.onclose = null;
        socket.close();
      }
      if (reconnectTimeout) {
        clearTimeout(reconnectTimeout);
      }
      reconnectAttempts = 0;
      
      allCandles = [];
      isUserZooming = false;
      updateMainButton();
      
      document.getElementById('info').textContent = 'Перезагрузка с новым интервалом...';
      
      loadHistory().then(initWebSocket);
    });
  });

  // ========== ДВОЙНОЙ КЛИК ДЛЯ СБРОСА ЗУМА ==========
  document.getElementById('container').addEventListener('dblclick', () => {
    isUserZooming = false;
    setVisibleRange();
    updateInfo();
    updateMainButton();
    
    if (tg && tg.HapticFeedback) {
      tg.HapticFeedback.impactOccurred('medium');
    }
  });

  // ========== ЗАПУСК ПРИЛОЖЕНИЯ ==========
  loadHistory().then(initWebSocket);
</script>

</body>
</html>