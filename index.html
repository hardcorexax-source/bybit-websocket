<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>BTC/USDT Chart</title>

  <!-- Highcharts Stock -->
  <script src="https://code.highcharts.com/stock/highstock.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>

  <style>
    :root {
      --tg-theme-bg-color: #ffffff;
      --tg-theme-text-color: #000000;
      --tg-theme-hint-color: #999999;
      --tg-theme-link-color: #2481cc;
      --tg-theme-button-color: #2481cc;
      --tg-theme-button-text-color: #ffffff;
      --tg-theme-secondary-bg-color: #f4f4f5;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html {
      position: fixed;
      width: 100%;
      height: 100%;
      overflow: hidden;
      -webkit-text-size-adjust: 100%;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      height: 100%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      touch-action: pan-y;
    }

    #controls {
      padding: 12px;
      background: var(--tg-theme-bg-color);
      border-bottom: 1px solid var(--tg-theme-hint-color);
      overflow-x: auto;
      overflow-y: hidden;
      white-space: nowrap;
      flex-shrink: 0;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    #controls::-webkit-scrollbar {
      display: none;
    }

    #controls strong {
      display: block;
      margin-bottom: 8px;
      font-size: 13px;
      color: var(--tg-theme-hint-color);
      font-weight: 500;
      user-select: none;
    }

    .interval-btn {
      padding: 8px 14px;
      margin-right: 6px;
      border: 1px solid var(--tg-theme-hint-color);
      background: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.15s ease;
      display: inline-block;
      user-select: none;
      font-weight: 500;
    }

    .interval-btn:active {
      transform: scale(0.96);
      opacity: 0.8;
    }

    .interval-btn.active {
      background: var(--tg-theme-button-color);
      color: var(--tg-theme-button-text-color);
      border-color: var(--tg-theme-button-color);
      font-weight: 600;
    }

    #container {
      flex: 1;
      width: 100%;
      background: var(--tg-theme-bg-color);
      overflow: hidden;
      position: relative;
    }

    #info {
      padding: 10px 15px;
      background: var(--tg-theme-secondary-bg-color);
      font-size: 12px;
      color: var(--tg-theme-hint-color);
      border-top: 1px solid var(--tg-theme-hint-color);
      flex-shrink: 0;
      user-select: none;
      line-height: 1.4;
    }
  </style>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

<div id="controls">
  <strong>–ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–≤–µ—á–µ–π:</strong>
  <button class="interval-btn" data-interval="1000">1 —Å–µ–∫</button>
  <button class="interval-btn" data-interval="5000">5 —Å–µ–∫</button>
  <button class="interval-btn" data-interval="15000">15 —Å–µ–∫</button>
  <button class="interval-btn" data-interval="30000">30 —Å–µ–∫</button>
  <button class="interval-btn active" data-interval="60000">1 –º–∏–Ω</button>
  <button class="interval-btn" data-interval="300000">5 –º–∏–Ω</button>
  <button class="interval-btn" data-interval="900000">15 –º–∏–Ω</button>
</div>
<div id="container"></div>
<div id="info">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>

<script>
  // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM WEBAPP ==========
  let tg = window.Telegram?.WebApp;
  
  if (tg) {
    tg.ready();
    
    // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
    tg.expand();
    
    tg.web_app_expand();
    
    // –Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ SDK
    tg.requestFullScreen(); 
    
    // –û—Ç–∫–ª—é—á–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è
    tg.isClosingConfirmationEnabled = false;
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ (header color)
    try {
      if (tg.setHeaderColor) {
        tg.setHeaderColor('secondary_bg_color');
      }
    } catch (e) {
      console.log('setHeaderColor –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è:', e);
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç —Ñ–æ–Ω–∞
    try {
      if (tg.setBackgroundColor) {
        tg.setBackgroundColor(tg.themeParams?.secondary_bg_color || '#f4f4f5');
      }
    } catch (e) {
      console.log('setBackgroundColor –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è:', e);
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
    if (tg.BackButton) {
      tg.BackButton.show();
      tg.BackButton.onClick(() => {
        tg.close();
      });
    }
    
    // –û—Ç–∫–ª—é—á–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ —Å–≤–∞–π–ø—ã
    try {
      if (tg.disableVerticalSwipes) {
        tg.disableVerticalSwipes();
      }
    } catch (e) {
      console.log('disableVerticalSwipes –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
    }
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É Telegram
    if (tg.themeParams) {
      const p = tg.themeParams;
      const root = document.documentElement;
      
      root.style.setProperty('--tg-theme-bg-color', p.bg_color || '#ffffff');
      root.style.setProperty('--tg-theme-text-color', p.text_color || '#000000');
      root.style.setProperty('--tg-theme-hint-color', p.hint_color || '#999999');
      root.style.setProperty('--tg-theme-link-color', p.link_color || '#2481cc');
      root.style.setProperty('--tg-theme-button-color', p.button_color || '#2481cc');
      root.style.setProperty('--tg-theme-button-text-color', p.button_text_color || '#ffffff');
      root.style.setProperty('--tg-theme-secondary-bg-color', p.secondary_bg_color || '#f4f4f5');
    }
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
    if (tg.MainButton) {
      tg.MainButton.setText('–°–±—Ä–æ—Å–∏—Ç—å –∑—É–º');
      tg.MainButton.color = tg.themeParams?.button_color || '#2481cc';
      tg.MainButton.textColor = tg.themeParams?.button_text_color || '#ffffff';
    }
    
    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    console.log('=== Telegram WebApp Info ===');
    console.log('Version:', tg.version);
    console.log('Platform:', tg.platform);
    console.log('Color scheme:', tg.colorScheme);
    console.log('Is expanded:', tg.isExpanded);
    console.log('Viewport height:', tg.viewportHeight);
    console.log('Viewport stable height:', tg.viewportStableHeight);
  } else {
    console.warn('Telegram WebApp –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω. –û—Ç–∫—Ä—ã—Ç–æ –Ω–µ –≤ Telegram?');
  }

  // ========== –ü–û–õ–£–ß–ï–ù–ò–ï –¶–í–ï–¢–û–í –¢–ï–ú–´ ==========
  const getThemeColors = () => {
    const s = getComputedStyle(document.documentElement);
    return {
      bg: s.getPropertyValue('--tg-theme-bg-color').trim() || '#ffffff',
      text: s.getPropertyValue('--tg-theme-text-color').trim() || '#000000',
      hint: s.getPropertyValue('--tg-theme-hint-color').trim() || '#999999',
      button: s.getPropertyValue('--tg-theme-button-color').trim() || '#2481cc',
      secondaryBg: s.getPropertyValue('--tg-theme-secondary-bg-color').trim() || '#f4f4f5'
    };
  };

  // ========== –ù–ê–°–¢–†–û–ô–ö–ò –ì–†–ê–§–ò–ö–ê ==========
  const VISIBLE_CANDLES = 50;
  let CANDLE_INTERVAL = 60000;
  
  let allCandles = [];
  let isUserZooming = false;
  let socket = null;
  let reconnectAttempts = 0;
  const maxReconnectAttempts = 10;
  let reconnectTimeout = null;

  const themeColors = getThemeColors();

  // ========== –°–û–ó–î–ê–ù–ò–ï –ì–†–ê–§–ò–ö–ê ==========
  const chart = Highcharts.stockChart('container', {
    chart: {
      backgroundColor: themeColors.bg,
      style: {
        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'
      },
      events: {
        selection: function(event) {
          if (event.xAxis) {
            isUserZooming = true;
            updateMainButton();
            return true;
          }
        }
      }
    },
    rangeSelector: { 
      enabled: true,
      buttonTheme: {
        fill: themeColors.bg,
        stroke: themeColors.hint,
        style: {
          color: themeColors.text,
          fontSize: '12px'
        },
        states: {
          hover: {
            fill: themeColors.secondaryBg,
            style: {
              color: themeColors.text
            }
          },
          select: {
            fill: themeColors.button,
            stroke: themeColors.button,
            style: {
              color: '#ffffff'
            }
          }
        }
      },
      inputStyle: {
        color: themeColors.text,
        backgroundColor: themeColors.bg
      },
      labelStyle: {
        color: themeColors.hint
      },
      buttons: [{
        type: 'minute',
        count: 5,
        text: '5m'
      }, {
        type: 'minute',
        count: 15,
        text: '15m'
      }, {
        type: 'minute',
        count: 30,
        text: '30m'
      }, {
        type: 'hour',
        count: 1,
        text: '1h'
      }, {
        type: 'all',
        text: '–í—Å–µ'
      }],
      selected: 0,
      inputEnabled: false
    },
    title: { 
      text: 'BTC/USDT',
      style: {
        color: themeColors.text,
        fontSize: '16px',
        fontWeight: '600'
      }
    },
    xAxis: {
      lineColor: themeColors.hint,
      tickColor: themeColors.hint,
      labels: {
        style: {
          color: themeColors.text,
          fontSize: '11px'
        }
      },
      events: {
        afterSetExtremes: function(e) {
          if (e.trigger === 'rangeSelectorButton' || e.trigger === 'navigator') {
            isUserZooming = true;
            updateMainButton();
          }
          updateInfo();
        }
      }
    },
    yAxis: {
      gridLineColor: themeColors.hint,
      labels: {
        style: {
          color: themeColors.text,
          fontSize: '11px'
        },
        align: 'left',
        x: 5
      },
      opposite: true
    },
    series: [{
      type: 'candlestick',
      name: 'BTC/USDT',
      data: [],
      color: '#ef4444',
      upColor: '#10b981',
      lineColor: '#ef4444',
      upLineColor: '#10b981',
      tooltip: { 
        valueDecimals: 2,
        backgroundColor: themeColors.secondaryBg,
        borderColor: themeColors.hint,
        style: {
          color: themeColors.text,
          fontSize: '12px'
        }
      }
    }],
    tooltip: {
      backgroundColor: themeColors.secondaryBg,
      borderColor: themeColors.hint,
      borderRadius: 8,
      style: {
        color: themeColors.text,
        fontSize: '12px'
      }
    },
    credits: { enabled: false },
    navigator: { 
      enabled: true,
      height: 40,
      maskFill: themeColors.hint + '33',
      outlineColor: themeColors.hint,
      handles: {
        backgroundColor: themeColors.button,
        borderColor: themeColors.hint
      },
      xAxis: {
        gridLineColor: themeColors.hint,
        labels: {
          style: {
            color: themeColors.hint,
            fontSize: '10px'
          }
        }
      }
    },
    scrollbar: { 
      enabled: true,
      height: 8,
      barBackgroundColor: themeColors.hint,
      barBorderColor: themeColors.hint,
      buttonBackgroundColor: themeColors.secondaryBg,
      buttonBorderColor: themeColors.hint,
      buttonArrowColor: themeColors.text,
      rifleColor: themeColors.text,
      trackBackgroundColor: themeColors.secondaryBg,
      trackBorderColor: themeColors.hint
    }
  });

  const series = chart.series[0];

  // ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ì–õ–ê–í–ù–û–ô –ö–ù–û–ü–ö–ò TELEGRAM ==========
  function updateMainButton() {
    if (tg && tg.MainButton) {
      if (isUserZooming) {
        tg.MainButton.show();
      } else {
        tg.MainButton.hide();
      }
    }
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
  if (tg && tg.MainButton) {
    tg.MainButton.onClick(() => {
      isUserZooming = false;
      setVisibleRange();
      updateInfo();
      updateMainButton();
      
      if (tg.HapticFeedback) {
        tg.HapticFeedback.impactOccurred('light');
      }
    });
  }

  // ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–§–û–†–ú–ê–¶–ò–ò ==========
  function updateInfo() {
    const visibleData = series.data.filter(point => point.isInside);
    const intervalText = CANDLE_INTERVAL >= 60000 
      ? `${CANDLE_INTERVAL/60000} –º–∏–Ω` 
      : `${CANDLE_INTERVAL/1000} —Å–µ–∫`;
    
    document.getElementById('info').textContent = 
      `–ò–Ω—Ç–µ—Ä–≤–∞–ª: ${intervalText} ‚Ä¢ –í—Å–µ–≥–æ: ${allCandles.length} ‚Ä¢ –í–∏–¥–∏–º—ã—Ö: ${visibleData.length} ‚Ä¢ ` +
      `${isUserZooming ? 'üîç –†—É—á–Ω–æ–π –∑—É–º' : 'üìä –ê–≤—Ç–æ-–ø—Ä–æ–∫—Ä—É—Ç–∫–∞'}`;
  }

  // ========== –£–°–¢–ê–ù–û–í–ö–ê –í–ò–î–ò–ú–û–ì–û –î–ò–ê–ü–ê–ó–û–ù–ê ==========
  function setVisibleRange() {
    if (!isUserZooming && allCandles.length > 0) {
      const lastCandle = allCandles[allCandles.length - 1];
      const firstVisible = allCandles[Math.max(0, allCandles.length - VISIBLE_CANDLES)];
      
      chart.xAxis[0].setExtremes(
        firstVisible[0],
        lastCandle[0] + CANDLE_INTERVAL,
        true,
        false
      );
    }
  }

  // ========== –ó–ê–ì–†–£–ó–ö–ê –ò–°–¢–û–†–ò–ß–ï–°–ö–ò–• –î–ê–ù–ù–´–• ==========
  async function loadHistory() {
    try {
      let apiInterval = '1m';
      if (CANDLE_INTERVAL >= 60000) {
        const minutes = CANDLE_INTERVAL / 60000;
        if (minutes >= 60) apiInterval = `${minutes/60}h`;
        else apiInterval = `${minutes}m`;
      }
      
      const url = `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${apiInterval}&limit=100`;
      const response = await fetch(url);
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();

      allCandles = data.map(c => [
        c[0],
        parseFloat(c[1]),
        parseFloat(c[2]),
        parseFloat(c[3]),
        parseFloat(c[4])
      ]);

      series.setData(allCandles, false);
      setVisibleRange();
      chart.redraw();
      updateInfo();
      
      document.getElementById('info').textContent = `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allCandles.length} —Å–≤–µ—á–µ–π. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...`;
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
      document.getElementById('info').textContent = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
      
      if (tg && tg.showAlert) {
        tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
      }
    }
  }

  // ========== WEBSOCKET –î–õ–Ø –†–ï–ê–õ–¨–ù–û–ì–û –í–†–ï–ú–ï–ù–ò ==========
  function initWebSocket() {
    if (socket) {
      socket.onclose = null;
      socket.close();
    }

    socket = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@trade');

    socket.onopen = () => {
      console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
      reconnectAttempts = 0;
      updateInfo();
    };

    socket.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      const price = parseFloat(msg.p);
      const time = msg.T;

      const candleTime = Math.floor(time / CANDLE_INTERVAL) * CANDLE_INTERVAL;
      let candleIndex = allCandles.findIndex(c => c[0] === candleTime);

      if (candleIndex === -1) {
        const newCandle = [candleTime, price, price, price, price];
        allCandles.push(newCandle);
        series.addPoint(newCandle, false);
        setVisibleRange();
        chart.redraw();
        updateInfo();
      } else {
        const candle = allCandles[candleIndex];
        candle[2] = Math.max(candle[2], price);
        candle[3] = Math.min(candle[3], price);
        candle[4] = price;
        
        if (series.data[candleIndex]) {
          series.data[candleIndex].update(candle, true, false);
        }
      }
    };

    socket.onerror = (err) => {
      console.error("‚ùå WebSocket –æ—à–∏–±–∫–∞:", err);
    };

    socket.onclose = (event) => {
      console.warn("‚ö†Ô∏è WebSocket –∑–∞–∫—Ä—ã—Ç", event.code, event.reason);
      
      if (reconnectAttempts < maxReconnectAttempts) {
        reconnectAttempts++;
        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
        console.log(`üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${delay/1000} —Å–µ–∫ (–ø–æ–ø—ã—Ç–∫–∞ ${reconnectAttempts})`);
        
        if (reconnectTimeout) clearTimeout(reconnectTimeout);
        reconnectTimeout = setTimeout(initWebSocket, delay);
      } else {
        console.error('‚ùå –ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
        document.getElementById('info').textContent = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
      }
    };
  }

  // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–ù–û–ü–û–ö –ò–ù–¢–ï–†–í–ê–õ–û–í ==========
  document.querySelectorAll('.interval-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      if (tg && tg.HapticFeedback) {
        tg.HapticFeedback.impactOccurred('light');
      }
      
      document.querySelectorAll('.interval-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      CANDLE_INTERVAL = parseInt(btn.dataset.interval);
      
      if (socket) {
        socket.onclose = null;
        socket.close();
      }
      if (reconnectTimeout) {
        clearTimeout(reconnectTimeout);
      }
      reconnectAttempts = 0;
      
      allCandles = [];
      isUserZooming = false;
      updateMainButton();
      
      document.getElementById('info').textContent = 'üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å –Ω–æ–≤—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º...';
      
      loadHistory().then(initWebSocket);
    });
  });

  // ========== –î–í–û–ô–ù–û–ô –ö–õ–ò–ö –î–õ–Ø –°–ë–†–û–°–ê –ó–£–ú–ê ==========
  let lastTap = 0;
  document.getElementById('container').addEventListener('click', (e) => {
    const currentTime = new Date().getTime();
    const tapLength = currentTime - lastTap;
    
    if (tapLength < 300 && tapLength > 0) {
      // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫
      isUserZooming = false;
      setVisibleRange();
      updateInfo();
      updateMainButton();
      
      if (tg && tg.HapticFeedback) {
        tg.HapticFeedback.impactOccurred('medium');
      }
      
      e.preventDefault();
    }
    
    lastTap = currentTime;
  });

  // ========== –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ==========
  loadHistory().then(initWebSocket);
</script>

</body>
</html>