<!DOCTYPE html>

<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ñ–∏–≤–æ–π —Å–≤–µ—á–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫ BTC/USDT —Å –∏—Å—Ç–æ—Ä–∏–µ–π</title>

  <!-- Highcharts Stock -->

  <script src="https://code.highcharts.com/stock/highstock.js"></script>

  <script src="https://code.highcharts.com/modules/exporting.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background: #f3f4f6;
    }
    #container {
      height: 600px;
      min-width: 600px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    #info {
      margin-top: 10px;
      padding: 10px;
      background: white;
      border-radius: 5px;
      font-size: 14px;
      color: #666;
    }
  </style>

</head>
<body>

<h2>üíπ –ñ–∏–≤–æ–π —Å–≤–µ—á–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫ BTC/USDT —Å –∏—Å—Ç–æ—Ä–∏–µ–π</h2>
<div id="container"></div>
<div id="info">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>

<script>
  const VISIBLE_CANDLES = 50; // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏–¥–∏–º—ã—Ö —Å–≤–µ—á–µ–π
  const CANDLE_INTERVAL = 60000; // 1 –º–∏–Ω—É—Ç–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
  
  let allCandles = []; // –≤—Å–µ —Å–≤–µ—á–∏ (–∏—Å—Ç–æ—Ä–∏—è + –Ω–æ–≤—ã–µ)
  let isUserZooming = false;

  const chart = Highcharts.stockChart('container', {
    chart: {
      events: {
        selection: function(event) {
          if (event.xAxis) {
            isUserZooming = true;
            return true;
          }
        }
      }
    },
    rangeSelector: { 
      enabled: true,
      buttons: [{
        type: 'minute',
        count: 30,
        text: '30m'
      }, {
        type: 'hour',
        count: 1,
        text: '1h'
      }, {
        type: 'hour',
        count: 3,
        text: '3h'
      }, {
        type: 'all',
        text: '–í—Å–µ'
      }],
      selected: 0,
      inputEnabled: false
    },
    title: { text: 'BTC/USDT ‚Äî —Å–≤–µ—á–∏ —Å –∏—Å—Ç–æ—Ä–∏–µ–π –∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏' },
    xAxis: {
      events: {
        afterSetExtremes: function(e) {
          if (e.trigger === 'rangeSelectorButton' || e.trigger === 'navigator') {
            isUserZooming = true;
          }
          updateInfo();
        }
      }
    },
    series: [{
      type: 'candlestick',
      name: 'BTC/USDT',
      data: [],
      color: '#dc2626',
      upColor: '#16a34a',
      tooltip: { valueDecimals: 2 }
    }],
    credits: { enabled: false },
    navigator: { enabled: true },
    scrollbar: { enabled: true }
  });

  const series = chart.series[0];

  function updateInfo() {
    const visibleData = series.data.filter(point => point.isInside);
    document.getElementById('info').textContent = 
      `–í—Å–µ–≥–æ —Å–≤–µ—á–µ–π: ${allCandles.length} | –í–∏–¥–∏–º—ã—Ö: ${visibleData.length} | ` +
      `–†–µ–∂–∏–º: ${isUserZooming ? '–†—É—á–Ω–æ–π –∑—É–º' : '–ê–≤—Ç–æ-–ø—Ä–æ–∫—Ä—É—Ç–∫–∞'}`;
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–¥–∏–º–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
  function setVisibleRange() {
    if (!isUserZooming && allCandles.length > 0) {
      const lastCandle = allCandles[allCandles.length - 1];
      const firstVisible = allCandles[Math.max(0, allCandles.length - VISIBLE_CANDLES)];
      
      chart.xAxis[0].setExtremes(
        firstVisible[0],
        lastCandle[0] + CANDLE_INTERVAL,
        true,
        false
      );
    }
  }

  // --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö ---
  async function loadHistory() {
    try {
      const url = `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&limit=100`;
      const response = await fetch(url);
      const data = await response.json();

      allCandles = data.map(c => [
        c[0],                  // timestamp
        parseFloat(c[1]),      // open
        parseFloat(c[2]),      // high
        parseFloat(c[3]),      // low
        parseFloat(c[4])       // close
      ]);

      // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —Å–≤–µ—á–∏ –≤ –≥—Ä–∞—Ñ–∏–∫
      series.setData(allCandles, false);
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–∏–º—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω
      setVisibleRange();
      
      chart.redraw();
      updateInfo();
      
      document.getElementById('info').textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allCandles.length} —Å–≤–µ—á–µ–π. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ live –¥–∞–Ω–Ω—ã–º...`;
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
      document.getElementById('info').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
    }
  }

  // --- WebSocket –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ ---
  function initWebSocket() {
    const socket = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@trade');

    socket.onopen = () => {
      document.getElementById('info').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ live –¥–∞–Ω–Ω—ã–º';
      updateInfo();
    };

    socket.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      const price = parseFloat(msg.p);
      const time = msg.T;

      const candleTime = Math.floor(time / CANDLE_INTERVAL) * CANDLE_INTERVAL;
      
      // –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–≤–µ—á—É
      let candleIndex = allCandles.findIndex(c => c[0] === candleTime);

      if (candleIndex === -1) {
        // –ù–æ–≤–∞—è —Å–≤–µ—á–∞
        const newCandle = [candleTime, price, price, price, price];
        allCandles.push(newCandle);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –≥—Ä–∞—Ñ–∏–∫
        series.addPoint(newCandle, false);
        
        // –ï—Å–ª–∏ –Ω–µ –≤ —Ä–µ–∂–∏–º–µ –∑—É–º–∞, –æ–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω
        setVisibleRange();
        
        chart.redraw();
        updateInfo();
      } else {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–≤–µ—á—É
        const candle = allCandles[candleIndex];
        candle[2] = Math.max(candle[2], price); // high
        candle[3] = Math.min(candle[3], price); // low
        candle[4] = price; // close
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫—É –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
        series.data[candleIndex].update(candle, true, false);
      }
    };

    socket.onerror = (err) => {
      console.error("WebSocket –æ—à–∏–±–∫–∞:", err);
      document.getElementById('info').textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ live –¥–∞–Ω–Ω—ã–º';
    };

    socket.onclose = () => {
      console.warn("WebSocket –∑–∞–∫—Ä—ã—Ç");
      document.getElementById('info').textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
      setTimeout(initWebSocket, 3000);
    };
  }

  // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –∞–≤—Ç–æ-–ø—Ä–æ–∫—Ä—É—Ç–∫–µ
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      isUserZooming = false;
      setVisibleRange();
      updateInfo();
    }
  });

  // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –∞–≤—Ç–æ-–ø—Ä–æ–∫—Ä—É—Ç–∫–µ
  document.getElementById('container').addEventListener('dblclick', () => {
    isUserZooming = false;
    setVisibleRange();
    updateInfo();
  });

  // --- –ó–∞–ø—É—Å–∫ ---
  loadHistory().then(initWebSocket);
</script>

</body>
</html>