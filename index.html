<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ñ–∏–≤–æ–π —Å–≤–µ—á–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫ BTC/USDT —Å –∏—Å—Ç–æ—Ä–∏–µ–π</title>

  <!-- Highcharts Stock -->
  <script src="https://code.highcharts.com/stock/highstock.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background: #f3f4f6;
    }
    #container {
      height: 600px;
      min-width: 600px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

<h2>üíπ –ñ–∏–≤–æ–π —Å–≤–µ—á–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫ BTC/USDT —Å –∏—Å—Ç–æ—Ä–∏–µ–π</h2>
<div id="container"></div>

<script>
  const chart = Highcharts.stockChart('container', {
    rangeSelector: { enabled: false },
    title: { text: 'BTC/USDT ‚Äî —Å–≤–µ—á–∏ —Å –∏—Å—Ç–æ—Ä–∏–µ–π –∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏' },
    series: [{
      type: 'candlestick',
      name: 'BTC/USDT',
      data: [],           // –ø–æ–∫–∞ –ø—É—Å—Ç–æ
      color: '#dc2626',
      upColor: '#16a34a',
      tooltip: { valueDecimals: 2 }
    }],
    credits: { enabled: false },
    navigator: { enabled: true },
    scrollbar: { enabled: true }
  });

  const series = chart.series[0];
  const candles = []; // –¥–ª—è —Ç–µ–∫—É—â–∏—Ö —Å–≤–µ—á–µ–π –∏–∑ WebSocket

  const candleInterval = 1000; // 1 –º–∏–Ω—É—Ç–∞

  // --- –®–∞–≥ 1: –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Å–≤–µ—á–∏ ---
  async function loadHistory() {
    const url = `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${candleInterval/1000}s&limit=50`;
    const response = await fetch(url);
    const data = await response.json();

    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç Highcharts: [time, open, high, low, close]
    data.forEach(c => {
      const candle = [
        c[0],                  // timestamp
        parseFloat(c[1]),      // open
        parseFloat(c[2]),      // high
        parseFloat(c[3]),      // low
        parseFloat(c[4])       // close
      ];
      candles.push(candle);
      series.addPoint(candle, false); // –Ω–µ —Ä–∏—Å—É–µ–º —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å –≤—Å–µ —Ä–∞–∑–æ–º
    });
    chart.redraw();
  }

  // --- –®–∞–≥ 2: –ü–æ–¥–∫–ª—é—á–∞–µ–º WebSocket ---
  function initWebSocket() {
    const socket = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@trade');

    socket.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      const price = parseFloat(msg.p);
      const time = msg.T;

      const candleTime = Math.floor(time / candleInterval) * candleInterval;
      let candle = candles.find(c => c[0] === candleTime);

      if (!candle) {
        candle = [candleTime, price, price, price, price];
        candles.push(candle);
        series.addPoint(candle, true, series.data.length >= 100);
      } else {
        candle[2] = Math.max(candle[2], price);
        candle[3] = Math.min(candle[3], price);
        candle[4] = price;
        const lastPoint = series.data[series.data.length - 1];
        lastPoint.update(candle, true, true);
      }
    };

    socket.onerror = (err) => console.error("WebSocket –æ—à–∏–±–∫–∞:", err);
    socket.onclose = () => console.warn("WebSocket –∑–∞–∫—Ä—ã—Ç");
  }

  // --- –ó–∞–ø—É—Å–∫ ---
  loadHistory().then(initWebSocket);
</script>

</body>
</html>
