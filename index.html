<!DOCTYPE html>

<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ñ–∏–≤–æ–π —Å–≤–µ—á–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫ BTC/USDT —Å –∏—Å—Ç–æ—Ä–∏–µ–π</title>

  <!-- Highcharts Stock -->

  <script src="https://code.highcharts.com/stock/highstock.js"></script>

  <script src="https://code.highcharts.com/modules/exporting.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background: #f3f4f6;
    }
    #controls {
      margin-bottom: 20px;
      padding: 15px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .interval-btn {
      padding: 8px 16px;
      margin-right: 10px;
      border: 2px solid #e5e7eb;
      background: white;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    .interval-btn:hover {
      border-color: #3b82f6;
      background: #eff6ff;
    }
    .interval-btn.active {
      border-color: #3b82f6;
      background: #3b82f6;
      color: white;
      font-weight: bold;
    }
    #container {
      height: 600px;
      min-width: 600px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    #info {
      margin-top: 10px;
      padding: 10px;
      background: white;
      border-radius: 5px;
      font-size: 14px;
      color: #666;
    }
  </style>

</head>
<body>

<h2>üíπ –ñ–∏–≤–æ–π —Å–≤–µ—á–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫ BTC/USDT —Å –∏—Å—Ç–æ—Ä–∏–µ–π</h2>
<div id="controls">
  <strong>–ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–≤–µ—á–µ–π:</strong>
  <button class="interval-btn" data-interval="1000">1 —Å–µ–∫—É–Ω–¥–∞</button>
  <button class="interval-btn" data-interval="5000">5 —Å–µ–∫—É–Ω–¥</button>
  <button class="interval-btn" data-interval="15000">15 —Å–µ–∫—É–Ω–¥</button>
  <button class="interval-btn" data-interval="30000">30 —Å–µ–∫—É–Ω–¥</button>
  <button class="interval-btn active" data-interval="60000">1 –º–∏–Ω—É—Ç–∞</button>
  <button class="interval-btn" data-interval="300000">5 –º–∏–Ω—É—Ç</button>
  <button class="interval-btn" data-interval="900000">15 –º–∏–Ω—É—Ç</button>
</div>
<div id="container"></div>
<div id="info">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>

<script>
  const VISIBLE_CANDLES = 50; // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏–¥–∏–º—ã—Ö —Å–≤–µ—á–µ–π
  let CANDLE_INTERVAL = 60000; // –Ω–∞—á–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª - 1 –º–∏–Ω—É—Ç–∞
  
  let allCandles = []; // –≤—Å–µ —Å–≤–µ—á–∏ (–∏—Å—Ç–æ—Ä–∏—è + –Ω–æ–≤—ã–µ)
  let isUserZooming = false;
  let socket = null;

  const chart = Highcharts.stockChart('container', {
    chart: {
      events: {
        selection: function(event) {
          if (event.xAxis) {
            isUserZooming = true;
            return true;
          }
        }
      }
    },
    rangeSelector: { 
      enabled: true,
      buttons: [{
        type: 'minute',
        count: 5,
        text: '5m'
      }, {
        type: 'minute',
        count: 15,
        text: '15m'
      }, {
        type: 'minute',
        count: 30,
        text: '30m'
      }, {
        type: 'hour',
        count: 1,
        text: '1h'
      }, {
        type: 'all',
        text: '–í—Å–µ'
      }],
      selected: 0,
      inputEnabled: false
    },
    title: { text: 'BTC/USDT ‚Äî —Å–≤–µ—á–∏ —Å –∏—Å—Ç–æ—Ä–∏–µ–π –∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏' },
    xAxis: {
      events: {
        afterSetExtremes: function(e) {
          if (e.trigger === 'rangeSelectorButton' || e.trigger === 'navigator') {
            isUserZooming = true;
          }
          updateInfo();
        }
      }
    },
    series: [{
      type: 'candlestick',
      name: 'BTC/USDT',
      data: [],
      color: '#dc2626',
      upColor: '#16a34a',
      tooltip: { valueDecimals: 2 }
    }],
    credits: { enabled: false },
    navigator: { enabled: true },
    scrollbar: { enabled: true }
  });

  const series = chart.series[0];

  function updateInfo() {
    const visibleData = series.data.filter(point => point.isInside);
    const intervalText = CANDLE_INTERVAL >= 60000 
      ? `${CANDLE_INTERVAL/60000} –º–∏–Ω` 
      : `${CANDLE_INTERVAL/1000} —Å–µ–∫`;
    
    document.getElementById('info').textContent = 
      `–ò–Ω—Ç–µ—Ä–≤–∞–ª: ${intervalText} | –í—Å–µ–≥–æ —Å–≤–µ—á–µ–π: ${allCandles.length} | –í–∏–¥–∏–º—ã—Ö: ${visibleData.length} | ` +
      `–†–µ–∂–∏–º: ${isUserZooming ? '–†—É—á–Ω–æ–π –∑—É–º' : '–ê–≤—Ç–æ-–ø—Ä–æ–∫—Ä—É—Ç–∫–∞'}`;
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–¥–∏–º–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
  function setVisibleRange() {
    if (!isUserZooming && allCandles.length > 0) {
      const lastCandle = allCandles[allCandles.length - 1];
      const firstVisible = allCandles[Math.max(0, allCandles.length - VISIBLE_CANDLES)];
      
      chart.xAxis[0].setExtremes(
        firstVisible[0],
        lastCandle[0] + CANDLE_INTERVAL,
        true,
        false
      );
    }
  }

  // --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö ---
  async function loadHistory() {
    try {
      // –î–ª—è Binance API –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–ª–∏–∂–∞–π—à–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
      let apiInterval = '1m';
      if (CANDLE_INTERVAL >= 60000) {
        const minutes = CANDLE_INTERVAL / 60000;
        if (minutes >= 60) apiInterval = `${minutes/60}h`;
        else apiInterval = `${minutes}m`;
      }
      
      const url = `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${apiInterval}&limit=100`;
      const response = await fetch(url);
      const data = await response.json();

      allCandles = data.map(c => [
        c[0],                  // timestamp
        parseFloat(c[1]),      // open
        parseFloat(c[2]),      // high
        parseFloat(c[3]),      // low
        parseFloat(c[4])       // close
      ]);

      // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —Å–≤–µ—á–∏ –≤ –≥—Ä–∞—Ñ–∏–∫
      series.setData(allCandles, false);
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–∏–º—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω
      setVisibleRange();
      
      chart.redraw();
      updateInfo();
      
      document.getElementById('info').textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allCandles.length} —Å–≤–µ—á–µ–π. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ live –¥–∞–Ω–Ω—ã–º...`;
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
      document.getElementById('info').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
    }
  }

  // --- WebSocket –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ ---
  let reconnectAttempts = 0;
  const maxReconnectAttempts = 10;
  let reconnectTimeout = null;

  function initWebSocket() {
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
    if (socket) {
      socket.onclose = null; // –£–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —á—Ç–æ–±—ã –Ω–µ –≤—ã–∑–≤–∞—Ç—å –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
      socket.close();
    }

    socket = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@trade');

    socket.onopen = () => {
      console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
      reconnectAttempts = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
      updateInfo();
    };

    socket.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      const price = parseFloat(msg.p);
      const time = msg.T;

      const candleTime = Math.floor(time / CANDLE_INTERVAL) * CANDLE_INTERVAL;
      
      // –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–≤–µ—á—É
      let candleIndex = allCandles.findIndex(c => c[0] === candleTime);

      if (candleIndex === -1) {
        // –ù–æ–≤–∞—è —Å–≤–µ—á–∞
        const newCandle = [candleTime, price, price, price, price];
        allCandles.push(newCandle);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –≥—Ä–∞—Ñ–∏–∫
        series.addPoint(newCandle, false);
        
        // –ï—Å–ª–∏ –Ω–µ –≤ —Ä–µ–∂–∏–º–µ –∑—É–º–∞, –æ–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω
        setVisibleRange();
        
        chart.redraw();
        updateInfo();
      } else {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–≤–µ—á—É
        const candle = allCandles[candleIndex];
        candle[2] = Math.max(candle[2], price); // high
        candle[3] = Math.min(candle[3], price); // low
        candle[4] = price; // close
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫—É –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
        if (series.data[candleIndex]) {
          series.data[candleIndex].update(candle, true, false);
        }
      }
    };

    socket.onerror = (err) => {
      console.error("WebSocket –æ—à–∏–±–∫–∞:", err);
    };

    socket.onclose = (event) => {
      console.warn("WebSocket –∑–∞–∫—Ä—ã—Ç", event.code, event.reason);
      
      // –ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
      if (reconnectAttempts < maxReconnectAttempts) {
        reconnectAttempts++;
        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000); // –ú–∞–∫—Å 30 —Å–µ–∫
        console.log(`–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${delay/1000} —Å–µ–∫ (–ø–æ–ø—ã—Ç–∫–∞ ${reconnectAttempts})`);
        
        if (reconnectTimeout) clearTimeout(reconnectTimeout);
        reconnectTimeout = setTimeout(initWebSocket, delay);
      } else {
        console.error('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
        document.getElementById('info').textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
      }
    };
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
  document.querySelectorAll('.interval-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
      document.querySelectorAll('.interval-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª
      CANDLE_INTERVAL = parseInt(btn.dataset.interval);
      
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä–æ–µ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
      if (socket) {
        socket.onclose = null; // –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        socket.close();
      }
      if (reconnectTimeout) {
        clearTimeout(reconnectTimeout);
      }
      reconnectAttempts = 0;
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
      allCandles = [];
      isUserZooming = false;
      
      document.getElementById('info').textContent = '–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å –Ω–æ–≤—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º...';
      
      loadHistory().then(initWebSocket);
    });
  });

  // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –∞–≤—Ç–æ-–ø—Ä–æ–∫—Ä—É—Ç–∫–µ
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      isUserZooming = false;
      setVisibleRange();
      updateInfo();
    }
  });

  // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –∞–≤—Ç–æ-–ø—Ä–æ–∫—Ä—É—Ç–∫–µ
  document.getElementById('container').addEventListener('dblclick', () => {
    isUserZooming = false;
    setVisibleRange();
    updateInfo();
  });

  // --- –ó–∞–ø—É—Å–∫ ---
  loadHistory().then(initWebSocket);
</script>

</body>
</html>